# Notion Markdown Converter AI Development Log

# HOW TO USE
- /!\ ONLY EVER APPEND TO THIS FILE
- At the end of the session, add a header with the current date. Under this header, explain everything you have achieved, the problems encountered, etc. Add anything that you think will be useful for your next session. 
- When reading this file, PAY CAREFUL ATTENTION TO THE DATES. Older information may be outdated.
- This is your own log and you manage it as you see fit. But make sure to also pay attention to DEV_LOG.md, which is the human developers' log. Also pay attention to the dates.

# 2025-08-10

## Project Overview

This project successfully implements a bidirectional converter between Notion API JSON format and Markdown. Both conversion directions are fully functional with comprehensive test coverage.

## Current Status

✅ **Completed**: JSON to Markdown conversion (16 tests passing)
✅ **Completed**: Markdown to JSON conversion (13 tests passing)
✅ **Completed**: Bidirectional conversion with round-trip support
✅ **Completed**: Comprehensive test suites for both converters
✅ **Completed**: Example scripts demonstrating usage
⚠️ **Resolved**: Terminal output issue (fixed by user)

## What Was Built

### 1. Main Converter Module (`notion_to_markdown.py`)

A comprehensive converter that handles Notion block types:

#### Supported Block Types:
- ✅ **Text Blocks**:
  - `paragraph`
  - `heading_1` → `# Heading`
  - `heading_2` → `## Heading`
  - `heading_3` → `### Heading`
  
- ✅ **Rich Text Formatting**:
  - Bold → `**text**`
  - Italic → `*text*`
  - Strikethrough → `~~text~~`
  - Code → `` `code` ``
  - Combined (bold+italic) → `***text***`
  - Underline → `<u>text</u>` (HTML fallback)
  - Links → `[text](url)`

- ✅ **Lists**:
  - `bulleted_list_item` → `- Item`
  - `numbered_list_item` → `1. Item`
  - `to_do` → `- [ ] Task` or `- [x] Task`
  - **Nested lists** are properly handled with indentation

- ✅ **Other Blocks**:
  - `quote` → `> Quote text`
  - `divider` → `---`
  - `code` → ` ```language\ncode\n``` `
  - `table` → Markdown tables with alignment

### 2. Test Suite (`test_notion_to_markdown.py`)

Comprehensive tests covering all block types and edge cases. All 16 tests are passing.

### 3. Usage Example (`example_usage.py`)

Shows how to use the converter in practice.

## Important Implementation Details

### 1. Nested List Handling

**Critical Discovery**: Children can be stored in two places in the JSON:
- At the block level: `block['children']`
- Inside the block type data: `block[block_type]['children']`

The converter checks both locations (see lines 105-109 in `notion_to_markdown.py`).

### 2. Indentation Rules

- **Bulleted lists**: Use 2 spaces per indent level
- **Numbered lists**: Use 3 spaces per indent level (for proper alignment)
- This matches standard Markdown conventions

### 3. Block Spacing

- Empty lines are added between different block types
- **Exception**: No empty line before a divider if the previous line ends with `:` 
- List items of the same type don't have spacing between them

### 4. Numbered List Counter

- Counter resets when exiting a numbered list (going to a different block type)
- Counter continues incrementing for consecutive numbered items
- Nested numbered lists continue the parent's numbering

### 5. Table Handling

Tables in Notion JSON have their rows stored in `table.children`, not `block.children`. The converter checks both locations.

## Known Quirks and Fixes Applied

1. **Horizontal Rule Spacing**: Fixed extra newline before `---` when preceded by text ending with `:`
2. **Nested List Indentation**: Fixed to use 3 spaces for numbered lists (was using 2)
3. **URL Trailing Slash**: The converter preserves URLs exactly as they appear in the JSON
4. **Quote Test Fix**: Test was expecting a quote that didn't exist in the reference data

## File Structure

```
notion_md_converter/
├── notion_to_markdown.py              # JSON to Markdown converter
├── markdown_to_notion.py              # Markdown to JSON converter
├── test_notion_to_markdown.py         # JSON to MD test suite (all passing!)
├── test_markdown_to_notion.py         # MD to JSON test suite (all passing!)
├── bidirectional_converter_example.py # Comprehensive demo of both converters
├── example_usage.py                   # Original usage examples
├── requirements.txt                   # Dependencies (notion-client, python-dotenv, pytest)
├── references/
│   ├── reference_1.json              # Sample Notion JSON
│   ├── reference_1.md                # Expected Markdown output
│   └── reference_2.json              # Another sample
├── output/                            # Generated by examples (gitignored)
│   ├── reference_1_converted.md      # JSON to MD conversion output
│   ├── sample.md                      # Sample markdown for testing
│   └── sample_converted.json         # MD to JSON conversion output
└── AI_DEVELOPMENT_LOG.md             # This file
```

## Terminal Output Issue

**Problem**: When running commands via `run_terminal_cmd`, output often gets truncated or shows only `^C`. This makes debugging difficult.

**Symptoms**:
- Commands appear to run but output is cut off
- Often see `bash: sed: command not found` warnings
- Results sometimes show just `^C` or partial output

**Impact**: Had to create many workaround scripts to write output to files instead of relying on terminal output.

## Markdown to JSON Converter Implementation (Completed)

### 2. Markdown to JSON Converter Module (`markdown_to_notion.py`)

A comprehensive parser that converts Markdown to Notion JSON format:

#### Features Implemented:
- **Block Type Detection**: Automatically identifies Markdown patterns and converts to appropriate Notion blocks
- **Rich Text Parsing**: Handles inline formatting including:
  - Bold (`**text**`)
  - Italic (`*text*`)
  - Bold+Italic (`***text***`)
  - Strikethrough (`~~text~~`)
  - Code (`` `code` ``)
  - Underline (`<u>text</u>`)
  - Links (`[text](url)`)
- **Nested Structures**: Properly handles nested lists with correct indentation
- **Title Extraction**: First `# Heading` becomes the page title
- **All Block Types Supported**: Paragraphs, headings, lists, todos, quotes, code blocks, tables, dividers

### 3. Test Suite (`test_markdown_to_notion.py`)

Comprehensive test coverage with 13 tests, all passing:
- Simple text conversion
- Heading levels
- Rich text formatting
- List types (bulleted, numbered, todo)
- Nested lists
- Code blocks and inline code
- Tables with headers
- Quotes
- Links
- Round-trip conversion tests

### 4. Bidirectional Converter Example (`bidirectional_converter_example.py`)

Demonstrates:
- JSON to Markdown conversion
- Markdown to JSON conversion
- Round-trip conversion with content preservation verification

## Next Steps

### Potential Enhancements:
1. **Extended Block Support**: Add support for more Notion-specific blocks (toggles, callouts, embeds)
2. **Metadata Preservation**: Store and restore page metadata (created time, last edited, etc.)
3. **API Integration**: Direct integration with Notion API for import/export
4. **CLI Tool**: Create a command-line interface for easy conversion
5. **Validation**: Add schema validation for JSON structure
6. **Error Handling**: More robust error handling and user-friendly error messages

## Testing the Current Implementation

```bash
# Run all tests for both converters
.venv/Scripts/python -m pytest -v

# Test JSON to Markdown converter only
.venv/Scripts/python -m pytest test_notion_to_markdown.py -v

# Test Markdown to JSON converter only  
.venv/Scripts/python -m pytest test_markdown_to_notion.py -v

# Run the bidirectional converter example
.venv/Scripts/python bidirectional_converter_example.py

# Convert JSON to Markdown
.venv/Scripts/python -c "from notion_to_markdown import json_to_markdown_file; json_to_markdown_file('references/reference_1.json', 'output.md')"

# Convert Markdown to JSON
.venv/Scripts/python -c "from markdown_to_notion import markdown_to_json_file; markdown_to_json_file('references/reference_1.md', 'output.json')"
```

## Usage Examples

### JSON to Markdown
```python
from notion_to_markdown import NotionToMarkdownConverter, json_to_markdown_file

# Simple file conversion
json_to_markdown_file('input.json', 'output.md')

# Or use the converter directly
converter = NotionToMarkdownConverter()
with open('input.json', 'r') as f:
    notion_data = json.load(f)
markdown = converter.convert_page(notion_data)
```

### Markdown to JSON
```python
from markdown_to_notion import MarkdownToNotionConverter, markdown_to_json_file

# Simple file conversion
markdown_to_json_file('input.md', 'output.json')

# Or use the converter directly
converter = MarkdownToNotionConverter()
notion_json = converter.convert_markdown(markdown_text)
```

## Key Learnings

1. **Notion's block model** is hierarchical with various ways to store children
2. **Markdown conventions** vary (e.g., 2 vs 3 space indentation for different list types)
3. **Test data accuracy** is crucial - ensure tests match actual data
4. **Round-trip conversion** requires careful handling of format variations
5. **Rich text parsing** needs to handle overlapping formatting patterns correctly
6. **Regex ordering matters** when parsing inline formatting - more specific patterns must come first

## Implementation Highlights

### Markdown Parsing Strategy
- **Sequential parsing**: Process line by line, tracking context and indentation
- **Pattern matching**: Use regex for identifying block types and inline formatting
- **State management**: Track current position and nesting levels during parsing
- **Lookahead/lookback**: Check surrounding lines for context (e.g., table detection)

### Challenges Solved
1. **Nested list handling**: Implemented indentation tracking to properly nest list items
2. **Mixed formatting**: Created a priority system for parsing overlapping text formats
3. **Table detection**: Used lookahead to distinguish tables from regular text with pipes
4. **Title extraction**: First H1 becomes page title, stored in properties section
5. **Format preservation**: Ensured round-trip conversion maintains content integrity

## Final Notes

Both converters are complete and fully tested with 29 total passing tests. The implementation provides:
- Clean, maintainable code with clear separation of concerns
- Comprehensive test coverage ensuring reliability
- Practical examples demonstrating real-world usage
- Full bidirectional conversion support

The project is ready for production use and can be easily extended to support additional Notion block types or Markdown extensions.

---

# 2025-08-24 - Major Refactoring and Extended Syntax Implementation

## Session Overview
- **Duration**: 1h 9m (API: 32m 48s)
- **Cost**: $21.12
- **Code Changes**: 2,019 lines added, 126 lines removed
- **Primary Goal**: Implement the three core stable functions specified in DEV_LOG.md

## Major Accomplishments

### 1. Core Architecture Refactoring ✅
Successfully implemented the three core conversion functions as specified:
- `NotionApiResponse → NotionPayload` (api_to_payload)
- `NotionPayload ⟷ MarkdownContent` (payload_to_markdown, markdown_to_payload)
- Created new module structure: `converters/`, `plugins/`, `scripts/`

### 2. Extended Syntax Support Implementation ✅
Added comprehensive support for Notion-specific elements in markdown:
- **Toggle blocks**: `- [>] toggle content`
- **Toggle headers**: `### [>] header content` with `is_toggleable: true`
- **Callouts**: `<aside>💡 content</aside>` → callout blocks with emoji icons
- **User mentions**: `<notion-user id="...">@username</notion-user>`
- **Page mentions**: `<notion-page id="..."></notion-page>` → link_to_page blocks
- **Date mentions**: `<notion-date>August 10, 2025</notion-date>` with ISO conversion
- **Equations**: `$E = mc^2$` → equation rich text elements
- **Column layouts**: `<notion-columns><notion-column>content</notion-column></notion-columns>`

### 3. Testing Infrastructure ✅
- Created auto-discovering test suite in `tests/test_converters.py`
- Tests dynamically find all reference files and test all conversion types
- Comprehensive coverage of API→Payload→Markdown→Payload roundtrips

### 4. API Integration ✅
- New minimalistic Notion API wrapper in `notion_markdown_converter/api.py`
- Handles pagination, 100-block limits, recursive block fetching
- Functions: `fetch_page_as_payload()`, `create_page_from_payload()`, etc.

### 5. Reference File Structure ✅
- Renamed files to new convention: `reference_X_api.json`, `reference_X_payload.json`, `reference_X.md`
- Cleaned payload files to remove API-specific fields (id, timestamps, etc.)
- Established payload files as permanent reference points

## Technical Discoveries

### Extended Syntax Was Missing
The original converters treated extended syntax as literal text (e.g., `- [>]` became regular bulleted_list_item). Investigation revealed:
- Original markdown files contained extended syntax for Notion elements
- Converters lacked parsing for toggle syntax, callouts, mentions, columns
- This functionality needed to be built from scratch, not restored

### Reference File Consistency Issues
- Some reference files had inconsistencies (titles, URLs with/without trailing slashes)
- Fixed by ensuring payload and markdown references match exactly
- User correctly pointed out title removal was wrong - restored and fixed payload instead

## Current System State

### Working ✅
- API to Payload conversion (cleaning API responses)
- Extended syntax parsing in both directions
- Basic conversion functionality for all block types
- Toggle blocks, callouts, mentions, equations, columns
- Auto-discovering test infrastructure

### Needs Refinement ⚠️
- Character encoding mismatches (smart quotes `'` vs regular `'`)
- Spacing/empty line handling inconsistencies
- Block count discrepancies in markdown-to-payload conversion
- Full round-trip idempotency (10/14 tests failing)

## Test Results
```
4 PASSED (API to Payload conversions)
10 FAILED (Payload↔Markdown conversions and roundtrips)
```

## Remaining Tasks
From today's work, identified for future sessions:
1. Fix character encoding inconsistencies (smart quotes → regular quotes)
2. Resolve markdown-to-payload block count mismatches  
3. Perfect spacing/empty line handling
4. Ensure full round-trip idempotency
5. Clean up examples folder
6. Generate new README

## Key Files Modified
- `notion_markdown_converter/converters/` (new directory structure)
- `notion_markdown_converter/api.py` (new API wrapper)
- `tests/test_converters.py` (comprehensive test suite)
- Reference files structure and consistency fixes
- Extended syntax support in both payload↔markdown converters

## Architecture Notes
The system now properly separates:
- **API responses** (raw Notion API data with IDs, timestamps)
- **Payloads** (clean page data suitable for creation)
- **Markdown** (with extended syntax for Notion-specific elements)

This creates a clear data flow: API → Payload → Markdown → Payload → API, with each transformation being idempotent and reversible.

## Implementation Details

### Extended Syntax Patterns
The system now recognizes and converts these markdown extensions:
```markdown
# Standard markdown
**bold** *italic* `code` [link](url)

# Notion-specific extensions
- [>] Toggle content
### [>] Toggle header
<aside>💡 Callout content</aside>
<notion-user id="123">@username</notion-user>
<notion-page id="123"></notion-page>
<notion-date>August 10, 2025</notion-date>
$E = mc^2$

<notion-columns>
<notion-column>
Left column content
</notion-column>
<notion-column>
Right column content
</notion-column>
</notion-columns>
```

### Data Type Definitions
- **NotionApiResponse**: Raw API data with IDs, timestamps, metadata
- **NotionPayload**: Clean page data, ready for creation/conversion
- **MarkdownContent**: Text with extended syntax for Notion elements

### Converter Structure
```
notion_markdown_converter/
├── converters/
│   ├── api_to_payload.py          # Clean API responses
│   ├── payload_to_markdown.py     # Payload → Markdown
│   ├── markdown_to_payload.py     # Markdown → Payload
│   └── __init__.py                # Core API exports
├── api.py                         # Notion API wrapper
├── plugins/                       # Future extensibility
└── __init__.py                    # Main exports
```

## Lessons Learned

1. **Extended syntax was never implemented** - the reference files contained the intended syntax but converters didn't support it
2. **Reference file consistency is critical** - small inconsistencies (URLs, titles) cause test failures
3. **Block spacing is complex** - empty paragraphs, inter-block spacing, and list continuation rules need careful handling
4. **Notion's rich text model** supports equations, mentions, and other inline elements beyond basic markdown
5. **Column layouts** require recursive parsing and careful HTML-like tag handling

## Future Development Priorities

### High Priority
- Character encoding standardization
- Perfect round-trip idempotency
- Block count consistency

### Medium Priority  
- Examples folder cleanup
- README generation
- Performance optimization

### Low Priority
- Plugin system implementation
- Additional Notion block types
- CLI tool creation

This refactoring establishes the foundation for a robust, extensible Notion↔Markdown converter with proper support for Notion-specific features.

---

# 2025-08-24 - Spacing, Tables, Ordered Lists, Toggles, and Idempotency Fixes

## Session Overview
- Goal: Make payload→Markdown tests stable, fix Markdown→payload discrepancies, and get roundtrip idempotency green.
- Outcome: All conversion tests pass; idempotency passes for both references. Upload script works with tables.

## What Broke and Why
- Reference discrepancies:
  - reference_1.md had extraneous blank lines not present in the payload; these caused payload→Markdown mismatches.
  - Both references needed a final trailing blank line to reflect an explicit empty paragraph at the end of the payload.
- Spacing policy:
  - We were inserting blank lines between different block types. Notion API does not implicitly encode layout gaps; blank lines should come only from explicit empty paragraph blocks (paragraph.rich_text = []).
- Upload failure (API):
  - Table creation failed with “table.children should be defined” because our page creation flow stripped `table.children` while flattening children (valid for many blocks but not tables).
- Idempotency gaps:
  - Ordered list indentation for lettered/roman markers (a., b., i., ii., …) did not roundtrip.
  - Toggles (block and toggle headings) weren’t capturing nested children in Markdown→payload, and toggle headings weren’t flagged `is_toggleable`.

## Fixes Implemented
- Payload → Markdown
  - Removed auto blank-line insertion between block types; blank lines now come only from explicit empty paragraphs.
  - Preserved final trailing blank line when the payload ends with an empty paragraph.
  - For columns, trimmed trailing empty lines inside column content to avoid extra blank lines before `</notion-column>`; kept page-level trailing blank when present.
  - Result: reference_1 and reference_3 payload→Markdown tests pass.

- Markdown → Payload
  - Blank lines now parse as explicit empty paragraph blocks.
  - Do not extract leading H1 as page title (kept as a heading) to match the references.
  - Added support for ordered list markers beyond digits: letters (a., b., …) and roman numerals (i., ii., …). These are treated as `numbered_list_item`.
  - Updated indent detection: ordered lists (digits/letters/roman) use 3-space indentation; bullets remain 2-space.
  - Toggles:
    - `- [>]` toggle items now capture nested children under `toggle.children`.
    - Toggle headings (e.g., `### [>]`) now set `is_toggleable: true` and capture nested content as children.
  - Result: reference_1 and reference_3 Markdown→payload tests pass.

- Notion API Upload Path
  - Fixed `create_page_from_payload` to keep `table.children` intact during creation (and to skip child-stripping for `table`, `column_list`, and `column`).
  - Resolved API validation error: “body.children[n].table.children should be defined.” Upload of reference_1 now succeeds.

## Test Status
- Payload→Markdown: PASS (both references)
- Markdown→Payload: PASS (both references)
- Idempotency (Markdown → Payload → Markdown): PASS (both references)
- Idempotency (Payload → Markdown → Payload): PASS (both references)

## Notes and Learnings
- The Notion API returns blank lines only as explicit empty paragraph blocks; do not derive inter-block spacing implicitly.
- Table blocks must be created with `table.children` containing `table_row` children; flattening breaks creation.
- Ordered list marker variants in Markdown should normalize to `numbered_list_item` for consistent roundtrip behavior.
- Toggle blocks and toggleable headings require capturing nested content and proper `is_toggleable` flags to roundtrip.

## Follow-ups / Ideas
- Improve table alignment heuristics (we’re matching references; consider configurable alignment strategies if more datasets appear).
- Expand test corpus for complex nesting (mixed toggles inside lists, list blocks in columns, etc.).
- Consider normalizing smart quotes behavior explicitly if more references require it.