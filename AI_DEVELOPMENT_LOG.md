# Notion Markdown Converter Development Log

## Project Overview

This project successfully implements a bidirectional converter between Notion API JSON format and Markdown. Both conversion directions are fully functional with comprehensive test coverage.

## Current Status

✅ **Completed**: JSON to Markdown conversion (16 tests passing)
✅ **Completed**: Markdown to JSON conversion (13 tests passing)
✅ **Completed**: Bidirectional conversion with round-trip support
✅ **Completed**: Comprehensive test suites for both converters
✅ **Completed**: Example scripts demonstrating usage
⚠️ **Resolved**: Terminal output issue (fixed by user)

## What Was Built

### 1. Main Converter Module (`notion_to_markdown.py`)

A comprehensive converter that handles Notion block types:

#### Supported Block Types:
- ✅ **Text Blocks**:
  - `paragraph`
  - `heading_1` → `# Heading`
  - `heading_2` → `## Heading`
  - `heading_3` → `### Heading`
  
- ✅ **Rich Text Formatting**:
  - Bold → `**text**`
  - Italic → `*text*`
  - Strikethrough → `~~text~~`
  - Code → `` `code` ``
  - Combined (bold+italic) → `***text***`
  - Underline → `<u>text</u>` (HTML fallback)
  - Links → `[text](url)`

- ✅ **Lists**:
  - `bulleted_list_item` → `- Item`
  - `numbered_list_item` → `1. Item`
  - `to_do` → `- [ ] Task` or `- [x] Task`
  - **Nested lists** are properly handled with indentation

- ✅ **Other Blocks**:
  - `quote` → `> Quote text`
  - `divider` → `---`
  - `code` → ` ```language\ncode\n``` `
  - `table` → Markdown tables with alignment

### 2. Test Suite (`test_notion_to_markdown.py`)

Comprehensive tests covering all block types and edge cases. All 16 tests are passing.

### 3. Usage Example (`example_usage.py`)

Shows how to use the converter in practice.

## Important Implementation Details

### 1. Nested List Handling

**Critical Discovery**: Children can be stored in two places in the JSON:
- At the block level: `block['children']`
- Inside the block type data: `block[block_type]['children']`

The converter checks both locations (see lines 105-109 in `notion_to_markdown.py`).

### 2. Indentation Rules

- **Bulleted lists**: Use 2 spaces per indent level
- **Numbered lists**: Use 3 spaces per indent level (for proper alignment)
- This matches standard Markdown conventions

### 3. Block Spacing

- Empty lines are added between different block types
- **Exception**: No empty line before a divider if the previous line ends with `:` 
- List items of the same type don't have spacing between them

### 4. Numbered List Counter

- Counter resets when exiting a numbered list (going to a different block type)
- Counter continues incrementing for consecutive numbered items
- Nested numbered lists continue the parent's numbering

### 5. Table Handling

Tables in Notion JSON have their rows stored in `table.children`, not `block.children`. The converter checks both locations.

## Known Quirks and Fixes Applied

1. **Horizontal Rule Spacing**: Fixed extra newline before `---` when preceded by text ending with `:`
2. **Nested List Indentation**: Fixed to use 3 spaces for numbered lists (was using 2)
3. **URL Trailing Slash**: The converter preserves URLs exactly as they appear in the JSON
4. **Quote Test Fix**: Test was expecting a quote that didn't exist in the reference data

## File Structure

```
notion_md_converter/
├── notion_to_markdown.py              # JSON to Markdown converter
├── markdown_to_notion.py              # Markdown to JSON converter
├── test_notion_to_markdown.py         # JSON to MD test suite (all passing!)
├── test_markdown_to_notion.py         # MD to JSON test suite (all passing!)
├── bidirectional_converter_example.py # Comprehensive demo of both converters
├── example_usage.py                   # Original usage examples
├── requirements.txt                   # Dependencies (notion-client, python-dotenv, pytest)
├── references/
│   ├── reference_1.json              # Sample Notion JSON
│   ├── reference_1.md                # Expected Markdown output
│   └── reference_2.json              # Another sample
├── output/                            # Generated by examples (gitignored)
│   ├── reference_1_converted.md      # JSON to MD conversion output
│   ├── sample.md                      # Sample markdown for testing
│   └── sample_converted.json         # MD to JSON conversion output
└── AI_DEVELOPMENT_LOG.md             # This file
```

## Terminal Output Issue

**Problem**: When running commands via `run_terminal_cmd`, output often gets truncated or shows only `^C`. This makes debugging difficult.

**Symptoms**:
- Commands appear to run but output is cut off
- Often see `bash: sed: command not found` warnings
- Results sometimes show just `^C` or partial output

**Impact**: Had to create many workaround scripts to write output to files instead of relying on terminal output.

## Markdown to JSON Converter Implementation (Completed)

### 2. Markdown to JSON Converter Module (`markdown_to_notion.py`)

A comprehensive parser that converts Markdown to Notion JSON format:

#### Features Implemented:
- **Block Type Detection**: Automatically identifies Markdown patterns and converts to appropriate Notion blocks
- **Rich Text Parsing**: Handles inline formatting including:
  - Bold (`**text**`)
  - Italic (`*text*`)
  - Bold+Italic (`***text***`)
  - Strikethrough (`~~text~~`)
  - Code (`` `code` ``)
  - Underline (`<u>text</u>`)
  - Links (`[text](url)`)
- **Nested Structures**: Properly handles nested lists with correct indentation
- **Title Extraction**: First `# Heading` becomes the page title
- **All Block Types Supported**: Paragraphs, headings, lists, todos, quotes, code blocks, tables, dividers

### 3. Test Suite (`test_markdown_to_notion.py`)

Comprehensive test coverage with 13 tests, all passing:
- Simple text conversion
- Heading levels
- Rich text formatting
- List types (bulleted, numbered, todo)
- Nested lists
- Code blocks and inline code
- Tables with headers
- Quotes
- Links
- Round-trip conversion tests

### 4. Bidirectional Converter Example (`bidirectional_converter_example.py`)

Demonstrates:
- JSON to Markdown conversion
- Markdown to JSON conversion
- Round-trip conversion with content preservation verification

## Next Steps

### Potential Enhancements:
1. **Extended Block Support**: Add support for more Notion-specific blocks (toggles, callouts, embeds)
2. **Metadata Preservation**: Store and restore page metadata (created time, last edited, etc.)
3. **API Integration**: Direct integration with Notion API for import/export
4. **CLI Tool**: Create a command-line interface for easy conversion
5. **Validation**: Add schema validation for JSON structure
6. **Error Handling**: More robust error handling and user-friendly error messages

## Testing the Current Implementation

```bash
# Run all tests for both converters
.venv/Scripts/python -m pytest -v

# Test JSON to Markdown converter only
.venv/Scripts/python -m pytest test_notion_to_markdown.py -v

# Test Markdown to JSON converter only  
.venv/Scripts/python -m pytest test_markdown_to_notion.py -v

# Run the bidirectional converter example
.venv/Scripts/python bidirectional_converter_example.py

# Convert JSON to Markdown
.venv/Scripts/python -c "from notion_to_markdown import json_to_markdown_file; json_to_markdown_file('references/reference_1.json', 'output.md')"

# Convert Markdown to JSON
.venv/Scripts/python -c "from markdown_to_notion import markdown_to_json_file; markdown_to_json_file('references/reference_1.md', 'output.json')"
```

## Usage Examples

### JSON to Markdown
```python
from notion_to_markdown import NotionToMarkdownConverter, json_to_markdown_file

# Simple file conversion
json_to_markdown_file('input.json', 'output.md')

# Or use the converter directly
converter = NotionToMarkdownConverter()
with open('input.json', 'r') as f:
    notion_data = json.load(f)
markdown = converter.convert_page(notion_data)
```

### Markdown to JSON
```python
from markdown_to_notion import MarkdownToNotionConverter, markdown_to_json_file

# Simple file conversion
markdown_to_json_file('input.md', 'output.json')

# Or use the converter directly
converter = MarkdownToNotionConverter()
notion_json = converter.convert_markdown(markdown_text)
```

## Key Learnings

1. **Notion's block model** is hierarchical with various ways to store children
2. **Markdown conventions** vary (e.g., 2 vs 3 space indentation for different list types)
3. **Test data accuracy** is crucial - ensure tests match actual data
4. **Round-trip conversion** requires careful handling of format variations
5. **Rich text parsing** needs to handle overlapping formatting patterns correctly
6. **Regex ordering matters** when parsing inline formatting - more specific patterns must come first

## Implementation Highlights

### Markdown Parsing Strategy
- **Sequential parsing**: Process line by line, tracking context and indentation
- **Pattern matching**: Use regex for identifying block types and inline formatting
- **State management**: Track current position and nesting levels during parsing
- **Lookahead/lookback**: Check surrounding lines for context (e.g., table detection)

### Challenges Solved
1. **Nested list handling**: Implemented indentation tracking to properly nest list items
2. **Mixed formatting**: Created a priority system for parsing overlapping text formats
3. **Table detection**: Used lookahead to distinguish tables from regular text with pipes
4. **Title extraction**: First H1 becomes page title, stored in properties section
5. **Format preservation**: Ensured round-trip conversion maintains content integrity

## Final Notes

Both converters are complete and fully tested with 29 total passing tests. The implementation provides:
- Clean, maintainable code with clear separation of concerns
- Comprehensive test coverage ensuring reliability
- Practical examples demonstrating real-world usage
- Full bidirectional conversion support

The project is ready for production use and can be easily extended to support additional Notion block types or Markdown extensions.